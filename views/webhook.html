{{ define "title" }}{{ defaultString .webhook.Name "webhook" }}{{ end }}
{{ define "content.html" }}

<div>
  <label>Url Path</label>
  <sl-copy-button from="blockTitle"></sl-copy-button>
  <div class="is-flex is-align-items-baseline">
    <sl-icon-button
      name="arrow-left"
      id="backButton"
      label="Blocks"
      href="/blocks/{{.webhook.BlockID}}"
      aria-label="Go back to Blocks"
    ></sl-icon-button>
    {{ template "editableTitle" .editableComponentParams }}
  </div>
</div>

<sl-dialog label="cURL Command Generator" id="curlGenerator" style="--width: 550px;">
  <div>
    <sl-select size="small" label="HTTP Method" id="method" value="GET">
      <sl-option value="GET">GET</sl-option>
      <sl-option value="POST">POST</sl-option>
      <sl-option value="PUT">PUT</sl-option>
      <sl-option value="DELETE">DELETE</sl-option>
      <sl-option value="PATCH">PATCH</sl-option>
    </sl-select>

    <sl-input
      clearable
      size="small"
      type="url"
      label="Request URL"
      id="url"
      placeholder="https://example.com/api"
    ></sl-input>

    <sl-select size="small" label="Content-Type" id="content-type">
      <sl-option value="application/json">application/json</sl-option>
      <sl-option value="application/x-www-form-urlencoded">application/x-www-form-urlencoded</sl-option>
      <sl-option value="text/plain">text/plain</sl-option>
      <sl-option value="custom">Custom</sl-option>
    </sl-select>

    <sl-input size="small" label="Custom Content-Type" id="custom-content-type" style="display: none;"></sl-input>

    <div id="headers-section">
      <h4 class="mt-2">Headers</h4>
      <div class="is-flex mb-10 header-row" style="gap: 10px;">
        <sl-input size="small" label="Header Name" class="header-name"></sl-input>
        <sl-input size="small" label="Header Value" class="header-value"></sl-input>
        <sl-button size="small" variant="danger" class="pt-5 remove-header">Remove</sl-button>
      </div>

      <div class="mt-2 mb-2">
        <sl-button size="small" id="add-header" variant="primary">Add Header</sl-button>
      </div>
    </div>

    <sl-textarea size="small" label="Body (for POST/PUT)" id="request-body" rows="4" clearable></sl-textarea>

    <sl-checkbox id="verbose">Verbose</sl-checkbox>
    <sl-checkbox id="insecure">Insecure (skip SSL)</sl-checkbox>

    <sl-input size="small" label="Timeout (seconds)" id="timeout" type="number" min="0"></sl-input>

    <div class="mt-2 mb-2">
      <sl-button size="small" variant="primary" id="generate-curl">Generate cURL</sl-button>
      <sl-button size="small" id="clear-fields">Clear</sl-button>
    </div>

    <div class="is-flex is-align-items-center">
      <code id="curl-output">//output</code>
      <sl-copy-button from="curl-output" class="copy-code-button"></sl-copy-button>
    </div>
  </div>
</sl-dialog>

<!-- Tabs -->
<sl-tab-group id="webhookTabGroup">
  <sl-tab slot="nav" panel="editor">Editor</sl-tab>
  <sl-tab slot="nav" panel="settings">Settings</sl-tab>
  <sl-tab slot="nav" panel="eventLogs" hx-get="/events/{{.Type}}/{{.webhook.ID}}" hx-target="#eventList" hx-trigger="click">Event Logs</sl-tab>

  <sl-tab-panel name="editor">
    <div id="alertBox"></div>
    <div class="is-flex is-flex-direction-row is-align-items-flex-end m-2 is-justify-content-space-between">
      <div class="is-flex is-flex-direction-row is-align-items-end">
        <sl-input placeholder="{{ defaultString .webhook.Name "" }}" disabled></sl-input>
        <sl-button
          class="ml-2"
          variant="primary"
          hx-patch="/webhooks/{{.webhook.ID}}"
          hx-target="#alertBox"
          hx-include="#webhookTabGroup [name]"
          hx-vals="js:{editor: getEditorVal()}"
        >
          Save
        </sl-button>
      </div>
      <div>
        <sl-icon-button name="question-circle" onclick="codeHelper.show()" aria-label="Show help"></sl-icon-button>
        {{ template "cheatsheet.html" }}
      </div>
    </div>

    <div class="is-flex m-2">
      <sl-select id="programType" name="programType" size="small" value="{{.programType}}">
        <sl-option value="bash">Bash</sl-option>
        <sl-option value="lua">Lua</sl-option>
      </sl-select>
      {{ if .showCurlGenerator }}
        <div id="curlGeneratorContainer" class="is-flex ml-2">
          <sl-button size="small" onclick="document.getElementById('curlGenerator').show()">cURL Generator</sl-button>
        </div>
      {{ end }}
    </div>

    <div id="codeEditor"></div>
  </sl-tab-panel>

  <sl-tab-panel name="settings">
    <div id="alertBoxSettings"></div>
    <form id="webhookConfig" hx-patch="/webhooks/{{.webhook.ID}}" hx-include="#webhookConfig [name]"  hx-vals="js:{editor: getEditorVal(), programType: document.getElementById('programType').value}" hx-target="#alertBoxSettings">
      <div class="is-flex is-justify-content-space-between">
        <div
          class="is-flex is-flex-direction-row is-align-items-flex-center m-2"
        >
          <div>
            <sl-select name="httpVerb" label="HTTP Verb" value={{.webhook.HttpMethod}} required>
              <sl-option value="GET">GET</sl-option>
              <sl-option value="POST">POST</sl-option>
              <sl-option value="PATCH">PATCH</sl-option>
              <sl-option value="DELETE">DELETE</sl-option>
            </sl-select>
          </div>
          <div class="ml-2 pt-5 is-align-self-center is-flex">
            <sl-radio-group name="active" value={{.webhook.Active}}>
                <sl-radio-button value=false>Disabled</sl-radio-button>
                <sl-radio-button value=true>Enabled</sl-radio-button>
            </sl-radio-group>
          </div>
        </div>

        <div class="ml-10 pt-2 is-align-self-center is-flex">
          <sl-button type="submit" variant="primary">Save</sl-button>
        </div>
      </div>

      <div class="m-2">
        <sl-details summary="Authorization" id="authSection" open>
          <p>A list of bearer tokens to grant access to this endpoint.</p>

          <sl-switch id="authEnabled" style="margin-top: 1rem;" {{ if .authConfig.Enabled }}checked{{ end }}>
            Require Bearer Token Authentication
          </sl-switch>

          <sl-alert id="authWarning" variant="warning" style="margin-top: 1rem; display: none;">
            <sl-icon slot="icon" name="exclamation-triangle"></sl-icon>
            <strong>Warning:</strong> Authentication is enabled but no tokens are configured. Please add at least one token or disable authentication.
          </sl-alert>

          <div style="margin-top: 1.5rem;" id="tokenManagement">
            <label style="display: block; font-weight: var(--sl-font-weight-semibold); margin-bottom: 0.5rem;">
              New Bearer Token
            </label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
              <sl-input id="newTokenInput" placeholder="Paste or generate a token" style="flex-grow: 1;"></sl-input>
              <sl-button id="generateTokenBtn">Generate</sl-button>
              <sl-button variant="primary" id="addTokenBtn">Add Token</sl-button>
            </div>
          </div>

          <div style="margin-top: 1.5rem;" id="activeTokensSection">
            <p style="font-weight: var(--sl-font-weight-semibold);">Active Tokens</p>
            <div id="tokensList">
              {{ range $index, $token := .authConfig.Tokens }}
              <div class="token-row" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;" data-token="{{$token}}">
                <sl-input value="{{ $token | maskToken }}" password readonly style="flex-grow: 1;"></sl-input>
                <sl-tooltip content="Copy Token">
                  <sl-copy-button value="{{ $token }}"></sl-copy-button>
                  <sl-icon-button name="copy-fill" class="copy-token-btn"></sl-icon-button>
                </sl-tooltip>
                <sl-tooltip content="Delete Token">
                  <sl-icon-button name="trash" class="delete-token-btn"></sl-icon-button>
                </sl-tooltip>
              </div>
              {{ end }}
            </div>
          </div>

          <input type="hidden" name="authConfig" id="authConfigInput" value="">
        </sl-details>
      </div>

      <div class="m-2">
        <sl-details summary="Exit Code & HTTP Response Mapping">
          <div id="mappings" class="is-flex is-flex-direction-column" style="gap: 12px;">
            {{range $exitCode, $httpResponseCode:= .httpExitPair}}
            <div id="columns-{{$exitCode}}" class="columns is-mobile is-align-items-end" style="margin-bottom: 0;">
              <div class="column is-5">
                <sl-input
                  name="exitCode[]"
                  type="number"
                  label="Exit Code"
                  value={{$exitCode}}
                  placeholder="Enter exit code"
                  required
                ></sl-input>
              </div>
              <div class="column is-5">
                <sl-input
                  name="httpResponseCode[]"
                  type="number"
                  value={{$httpResponseCode}}
                  label="HTTP Response Code"
                  placeholder="Enter HTTP code"
                  required
                ></sl-input>
              </div>
              <div class="column is-2 pb-4" >
                <sl-button type="button" variant="danger" size="small" onclick="document.getElementById('columns-{{$exitCode}}').remove()">
                  <sl-icon slot="prefix" name="dash-circle"></sl-icon>
                  Remove
                </sl-button>
              </div>
            </div>
            {{end}}
          </div>

          <div class="mt-3">
            <sl-button type="button" variant="primary" size="small" onclick="addRow()">
              <sl-icon slot="prefix" name="plus-circle"></sl-icon>
              Add Mapping
            </sl-button>
          </div>
        </sl-details>
      </div>

      <div class="m-2">
        <sl-details summary="Response Headers">
          <sl-textarea
            name="responseHeaders"
            value={{defaultString .webhook.ResponseHeaders "&nbsp;"}}
          ></sl-textarea>
        </sl-details>
      </div>

      <div class="m-2">
        <sl-details summary="Name">
          <sl-input
            name="name"
            value={{defaultString .webhook.Name "No name"}}
          ></sl-input>
        </sl-details>
      </div>

      <div class="m-2">
        <sl-details summary="Description">
          <sl-textarea
            name="description"
            value={{defaultString .webhook.Description "No description"}}
          ></sl-textarea>
        </sl-details>
      </div>

      <div class="m-2">
        <sl-details summary="Environment Variables">
          <sl-textarea
            name="env"
            label="Write environments variable here to make them accessible in script"
            value={{defaultString .webhook.EnvVariables "key=value"}}
          ></sl-textarea>
        </sl-details>
      </div>

      <div class="m-2">
        <sl-details summary="Cross Origin Resource Sharing (CORS)">
          <sl-textarea
            name="cors"
            label="A list of origins to allow browser-based requests"
            value={{defaultString .webhook.Cors "*"}}
          ></sl-textarea>
        </sl-details>
      </div>
    </form>
  </sl-tab-panel>

  <sl-tab-panel name="eventLogs">
    <div class="is-flex is-flex-direction-column" id="eventList"></div>
  </sl-tab-panel>
</sl-tab-group>

<script src="/static/javascript/curlgenerator.js"></script>
<script type="module">
  import { hideOrShowCurlGenerator, getProgramType } from '/static/javascript/editorcommon.js';
  import { createEditor } from '/static/javascript/editorsetup.js';

  const customWords = [{{ range $index, $key := .variables }}'{{$key}}',{{ end }}];
  const programType = document.getElementById("programType")?.value || "{{.programType}}";

  const editor = createEditor({
    fileContent: `{{ .fileContent }}`,
    customWords: customWords,
    parentElementId: 'codeEditor',
    initialMode: programType
  });

  window.getEditorVal = editor.getContent;

  document.getElementById("programType").addEventListener("sl-change", function (e) {
    const programType = e.target.value;
    hideOrShowCurlGenerator(programType);
    editor.switchMode(programType);
  });

  editor.view.focus();

  document.addEventListener("DOMContentLoaded", function() {
    const programType = document.getElementById("programType").value || {{.programType}};
    editor.switchMode(programType);
  });
</script>

<script>
    function addRow() {
    const mappingsDiv = document.getElementById("mappings");
    const newRow = document.createElement("div");
    const uniqueId = Date.now();
    newRow.id = `columns-${uniqueId}`;
    newRow.className = "columns is-mobile is-align-items-end";
    newRow.style.marginBottom = "0";
    newRow.innerHTML = `
      <div class="column is-5">
        <sl-input name="exitCode[]" type="number" label="Exit Code" placeholder="Enter exit code" required></sl-input>
      </div>
      <div class="column is-5">
        <sl-input name="httpResponseCode[]" type="number" label="HTTP Response Code" placeholder="Enter HTTP code" required></sl-input>
      </div>
      <div class="column is-2 pb-4">
        <sl-button type="button" variant="danger" size="small" onclick="deleteRow(this)">
          <sl-icon slot="prefix" name="dash-circle"></sl-icon>
          Remove
        </sl-button>
      </div>
    `;
    mappingsDiv.appendChild(newRow);
    updateRemoveButtons();
  }

  function deleteRow(button) {
    const row = button.closest(".columns");
    if (row) row.remove();
    updateRemoveButtons();
  }

  function updateRemoveButtons() {
    const mappingsDiv = document.getElementById("mappings");
    const rows = mappingsDiv.querySelectorAll(".columns");
    const removeButtons = mappingsDiv.querySelectorAll("sl-button[variant='danger']");

    removeButtons.forEach(button => {
      if (rows.length === 1) {
        button.style.display = "none";
      } else {
        button.style.display = "";
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    updateRemoveButtons();
    updateAuthConfigInput();
    validateAuthConfig(); // Validate on page load
  });

  // ===== Bearer Token Management =====
  let bearerTokens = {{ .authConfig.Tokens | toJSON }};

  function generateToken() {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let token = 'rf_live_';
    for (let i = 0; i < 32; i++) {
      token += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return token;
  }

  function updateAuthConfigInput() {
    const authEnabled = document.getElementById('authEnabled').checked;
    const authConfig = {
      enabled: authEnabled,
      tokens: bearerTokens
    };
    document.getElementById('authConfigInput').value = JSON.stringify(authConfig);

    // Validate auth configuration
    validateAuthConfig();
  }

  function validateAuthConfig() {
    const authEnabled = document.getElementById('authEnabled').checked;
    const authWarning = document.getElementById('authWarning');
    const saveButton = document.querySelector('#webhookConfig sl-button[type="submit"]');

    // Show warning if auth is enabled but no tokens exist
    if (authEnabled && bearerTokens.length === 0) {
      authWarning.style.display = 'block';
      authWarning.open = true;
      if (saveButton) {
        saveButton.disabled = true;
      }
    } else {
      authWarning.style.display = 'none';
      authWarning.open = false;
      if (saveButton) {
        saveButton.disabled = false;
      }
    }
  }

  function addTokenToUI(token, isUnsaved = false) {
    const tokensList = document.getElementById('tokensList');
    const tokenRow = document.createElement('div');
    tokenRow.className = 'token-row';
    tokenRow.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;';
    tokenRow.dataset.token = token;
    if (isUnsaved) {
      tokenRow.dataset.unsaved = 'true';
    }

    let maskedToken = '****' + token.slice(-4);
    if (token.lenght > 4) {
      maskedToken = '****' + token.slice(-4);
    } else {
      maskedToken = '****';
    }

    const unsavedBadge = isUnsaved ? '<sl-badge variant="warning" style="margin-left: 0.5rem;">Unsaved</sl-badge>' : '';

    tokenRow.innerHTML = `
      <sl-input value="${maskedToken}" password readonly style="flex-grow: 1;"></sl-input>
      ${unsavedBadge}
      <sl-tooltip content="Copy Token">
        <sl-icon-button name="copy-fill" class="copy-token-btn"></sl-icon-button>
      </sl-tooltip>
      <sl-tooltip content="Delete Token">
        <sl-icon-button name="trash" class="delete-token-btn"></sl-icon-button>
      </sl-tooltip>
    `;

    tokensList.appendChild(tokenRow);

    tokenRow.querySelector('.delete-token-btn').addEventListener('click', function() {
      const tokenToDelete = tokenRow.dataset.token;
      bearerTokens = bearerTokens.filter(t => t !== tokenToDelete);
      tokenRow.remove();
      updateAuthConfigInput();
      validateAuthConfig(); // Validate after removing token
    });
  }

  document.getElementById('generateTokenBtn').addEventListener('click', function() {
    const token = generateToken();
    document.getElementById('newTokenInput').value = token;
  });

  document.getElementById('addTokenBtn').addEventListener('click', function() {
    const tokenInput = document.getElementById('newTokenInput');
    const token = tokenInput.value.trim();

    if (!token) {
      alert('Please enter or generate a token');
      return;
    }

    if (bearerTokens.includes(token)) {
      alert('This token already exists');
      return;
    }

    bearerTokens.push(token);
    addTokenToUI(token, true); // Mark as unsaved
    tokenInput.value = '';
    updateAuthConfigInput();
  });

  document.getElementById('authEnabled').addEventListener('sl-change', function() {
    updateAuthConfigInput();
    validateAuthConfig(); // Validate when auth is toggled
  });

  document.querySelectorAll('.delete-token-btn').forEach((btn, index) => {
    btn.addEventListener('click', function() {
      const tokenRow = btn.closest('.token-row');
      const token = tokenRow.dataset.token;
      bearerTokens = bearerTokens.filter(t => t !== token);
      tokenRow.remove();
      updateAuthConfigInput();
      validateAuthConfig(); // Validate after removing token
    });
  });

  document.getElementById('webhookConfig').addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
      // Remove all unsaved badges
      document.querySelectorAll('.token-row[data-unsaved="true"]').forEach(row => {
        const badge = row.querySelector('sl-badge');
        if (badge) {
          badge.remove();
        }
        row.removeAttribute('data-unsaved');
      });
    }
  });

</script>

{{ end }}

